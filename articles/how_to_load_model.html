<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>How to load my model? â€¢ survinng</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to load my model?">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">survinng</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/how_to_load_model.html">How to load my model?</a></li>
    <li><a class="dropdown-item" href="../articles/Sim_time_independent.html">Simulation of Time-independent Effects</a></li>
    <li><a class="dropdown-item" href="../articles/Sim_time_dependent.html">Simulation of Time-dependent Effects</a></li>
    <li><a class="dropdown-item" href="../articles/multimodal.html">Example on Real Multi-modal Medical Data</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>How to load my model?</h1>
            
      

      <div class="d-none name"><code>how_to_load_model.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://bips-hb.github.io/survinng/">survinng</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://here.r-lib.org/" class="external-link">here</a></span><span class="op">)</span></span></code></pre></div>
<p>The <code>survinng</code> package is designed in a flexible way to
allow users to load models trained in R or Python using
<code>survivalmodels</code> or <code>pycox</code>, respectively. Under
the hood, the package uses the <code>torch</code> package and any base
neural network can be loaded and will be coverted to the corresponding
survival model, e.g., a DeepHit, DeepSurv, or CoxTime survival
model.</p>
<div class="section level2">
<h2 id="load-a-base-torch-model">Load a base <code>torch</code> model<a class="anchor" aria-label="anchor" href="#load-a-base-torch-model"></a>
</h2>
<p>This is the simplest way to load a model. The model must be a
<code><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">torch::nn_module</a></code> and any input (tabular, image, multimodal,
etc.) can be passed as long as the output dimension fits the expected
survival deep learning architecture. This means:</p>
<ul>
<li>For a <strong>DeepHit</strong> model, the output dimension must be
of shape <code>(batch_size, n_risks, n_time_bins)</code> where
<code>n_risks</code> is the number of competing risks and
<code>n_time_bins</code> the number of time bins.</li>
<li>For a <strong>DeepSurv</strong> and <strong>CoxTime</strong> models,
the output dimension must be of shape <code>(batch_size, 1)</code>,
since both models are designed to predict the risk of a single event and
are Cox-based.</li>
</ul>
<div class="section level3">
<h3 id="example-deephit-model">Example DeepHit model<a class="anchor" aria-label="anchor" href="#example-deephit-model"></a>
</h3>
<p>In this example, we will create a simple DeepHit model using the
<code>torch</code> package. The model will have 5 competing risks and 20
time bins. The input dimension will be 10 features. The model will be a
simple feedforward neural network with two hidden layers. Important to
note is that the output dimension is reshaped to
<code>(batch_size, n_risks, n_time_bins)</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_risks</span> <span class="op">&lt;-</span> <span class="fl">5</span></span>
<span><span class="va">n_time_bins</span> <span class="op">&lt;-</span> <span class="fl">20</span></span>
<span><span class="va">n_features</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Create the base model and data</span></span>
<span><span class="va">base_model_deephit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">n_features</span>, <span class="fl">128</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="va">n_risks</span> <span class="op">*</span> <span class="va">n_time_bins</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">net</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_reshape.html" class="external-link">torch_reshape</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">n_risks</span>, <span class="va">n_time_bins</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_deephit</span> <span class="op">&lt;-</span> <span class="fu">base_model_deephit</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">n_features</span><span class="op">)</span></span>
<span><span class="va">time_bins</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="va">n_time_bins</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check output</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model_deephit</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">shape</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50  5 20</span></span></code></pre></div>
<p>Now, we have our (untrained) base model and corresponding data. The
next step is to create a <code>survinng</code> explainer object. This is
done using the <code><a href="../reference/explain.html">explain()</a></code> function. The function takes the
model, data, and time bins (required for a DeepHit model) as input and
internally combines the base model with the DeepHit architecture. The
<code>model_type</code> argument is set to <code>"deephit"</code> to
indicate that the model is a DeepHit model. The function will return an
explainer object which can be used to compute all implemented
gradient-based feature attribution methods in the survival context.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create explainer object</span></span>
<span><span class="va">exp_deephit</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">model_deephit</span>, data <span class="op">=</span> <span class="va">data</span>, model_type <span class="op">=</span> <span class="st">"deephit"</span>,</span>
<span>                                 time_bins <span class="op">=</span> <span class="va">time_bins</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">exp_deephit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Explainer for DeepHit model</span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; Model Class: DeepHit</span></span>
<span><span class="co">#&gt; Number of instances in the input data:  50 </span></span>
<span><span class="co">#&gt; Competing risks: Not specified</span></span>
<span><span class="co">#&gt; Number of time bins in the model:  20 </span></span>
<span><span class="co">#&gt; Model parameters:</span></span>
<span><span class="co">#&gt;  - Number of input modalities:  1 </span></span>
<span><span class="co">#&gt;  - Number of features:  10 </span></span>
<span><span class="co">#&gt;  - Preprocessing function applied: Yes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Features (first 5 shown):</span></span>
<span><span class="co">#&gt; X1, X2, X3, X4, X5 </span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; To see more details, explore the individual elements of the object.</span></span>
<span></span>
<span><span class="co"># Calculate gradients</span></span>
<span><span class="va">grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_grad.html">surv_grad</a></span><span class="op">(</span><span class="va">exp_deephit</span>, instance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Plot gradients</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">grad</span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-3-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="example-deepsurv-model">Example DeepSurv model<a class="anchor" aria-label="anchor" href="#example-deepsurv-model"></a>
</h3>
<p>In this example, we will create a simple DeepSurv model using the
<code>torch</code> package. Since DeepSurv is a Cox-based model, the
output dimension will be of shape <code>(batch_size, 1)</code> and we
need the baseline hazard function.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_features</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Create baseline hazard function (50 time points)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">time</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">base_hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>, hazard <span class="op">=</span> <span class="va">hazard</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the base model and data</span></span>
<span><span class="va">base_model_deepsurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">n_features</span>, <span class="fl">128</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">1</span>, bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">net</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_deepsurv</span> <span class="op">&lt;-</span> <span class="fu">base_model_deepsurv</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">n_features</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check output</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model_deepsurv</span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">shape</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50  1</span></span></code></pre></div>
<p>Now, we have our (untrained) base model and corresponding data,
including the baseline hazard values The next step is to create a
<code>survinng</code> explainer object. This is done using the
<code><a href="../reference/explain.html">explain()</a></code> function. The function takes the model, data, and
baseline hazard (required for a DeepSurv model) as input and internally
combines the base model with the DeepSurv architecture. The
<code>model_type</code> argument is set to <code>"deepsurv"</code> to
indicate that the model is a DeepSurv model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create explainer object</span></span>
<span><span class="va">exp_deepsurv</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">model_deepsurv</span>, data <span class="op">=</span> <span class="va">data</span>, </span>
<span>                                  model_type <span class="op">=</span> <span class="st">"deepsurv"</span>,</span>
<span>                                  baseline_hazard <span class="op">=</span> <span class="va">base_hazard</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">exp_deepsurv</span><span class="op">)</span></span>
<span><span class="co">#&gt; Explainer for DeepSurv model</span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; Model Class: DeepSurv</span></span>
<span><span class="co">#&gt; Number of instances in the input data:  50 </span></span>
<span><span class="co">#&gt; Number of timepoints in the model:  50 (min: 0 , max: 10 )</span></span>
<span><span class="co">#&gt; Model parameters:</span></span>
<span><span class="co">#&gt;  - Number of input modalities:  1 </span></span>
<span><span class="co">#&gt;  - Number of features:  10 </span></span>
<span><span class="co">#&gt;  - Baseline hazard function: Yes</span></span>
<span><span class="co">#&gt;  - Preprocessing function applied: Yes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Features (first 5 shown):</span></span>
<span><span class="co">#&gt; X1, X2, X3, X4, X5 </span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; To see more details, explore the individual elements of the object.</span></span>
<span></span>
<span><span class="co"># Calculate IntGrad(t)</span></span>
<span><span class="va">ig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_intgrad.html">surv_intgrad</a></span><span class="op">(</span><span class="va">exp_deepsurv</span>, instance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show results as a contribution plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ig</span>, type <span class="op">=</span> <span class="st">"contr"</span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level3">
<h3 id="example-coxtime-model">Example CoxTime model<a class="anchor" aria-label="anchor" href="#example-coxtime-model"></a>
</h3>
<p>In this example, we will create a simple CoxTime model using the
<code>torch</code> package. It is very similar to the DeepSurv modelm
i.e., the output dimension of the base model will be of shape
<code>(batch_size, 1)</code> and we need the baseline hazard function
since it is a Cox-based model. However, the time points are integrated
to the input features, so the model will have
<code>n_features + 1</code> input features. Currently, the default
function for adding the time points to the input features is the
following one and assumes tabular data:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_features</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">n_features</span><span class="op">)</span></span>
<span><span class="va">t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_linspace.html" class="external-link">torch_linspace</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, steps <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span></span>
<span><span class="va">preprocess_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">batch_size</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="fu">size</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Input (batch_size, n_features) -&gt; (batch_size * t, n_features) (replicate each row t times)</span></span>
<span>  <span class="va">res</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="fu">repeat_interleave</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">t</span><span class="op">)</span>, dim <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Add time to input</span></span>
<span>  <span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_vstack.html" class="external-link">torch_vstack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">batch_size</span>, <span class="va">t</span><span class="op">$</span><span class="fu">unsqueeze</span><span class="op">(</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Combine both and return</span></span>
<span>  <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_cat.html" class="external-link">torch_cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">time</span><span class="op">)</span>, dim <span class="op">=</span> <span class="op">-</span><span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Input shape</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">shape</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 50 10</span></span>
<span></span>
<span><span class="co"># Shape after preprocessing</span></span>
<span><span class="fu">preprocess_fun</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">shape</span></span>
<span><span class="co">#&gt; [1] 2500   11</span></span></code></pre></div>
<p>However, you can pass your own preprocessing function to the
<code><a href="../reference/explain.html">explain()</a></code> function using the <code>preprocess_fun</code>
argument, but this option is still experimental and not fully
tested.</p>
<p>In the following code, we create the base model and data for the
CoxTime architecture. The model will have 10 + 1 features and 50 time
points for the baseline hazard function (this is basically the same as
the DeepSurv model from <a href="#example-deepsurv-model">this
Section</a>):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://torch.mlverse.org/docs" class="external-link">torch</a></span><span class="op">)</span></span>
<span><span class="va">n_features</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span></span>
<span><span class="co"># Create baseline hazard function (50 time points)</span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, length.out <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">time</span> <span class="op">-</span> <span class="fl">5</span><span class="op">)</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">base_hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>, hazard <span class="op">=</span> <span class="va">hazard</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the base model and data</span></span>
<span><span class="va">base_model_coxtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">n_features</span> <span class="op">+</span> <span class="fl">1</span>, <span class="fl">128</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">128</span>, <span class="fl">1</span>, bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">net</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span><span class="va">model_coxtime</span> <span class="op">&lt;-</span> <span class="fu">base_model_coxtime</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/torch_randn.html" class="external-link">torch_randn</a></span><span class="op">(</span><span class="fl">50</span>, <span class="va">n_features</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check output</span></span>
<span><span class="va">output</span> <span class="op">&lt;-</span> <span class="fu">model_coxtime</span><span class="op">(</span><span class="fu">preprocess_fun</span><span class="op">(</span><span class="va">data</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">output</span><span class="op">$</span><span class="va">shape</span><span class="op">)</span> <span class="co"># the instances are replicated t times</span></span>
<span><span class="co">#&gt; [1] 2500    1</span></span></code></pre></div>
<p>Now, we have our (untrained) base model and corresponding data,
including the baseline hazard values. The next step is to create a
<code>survinng</code> explainer object. This is done using the
<code><a href="../reference/explain.html">explain()</a></code> function. The function takes the model, data, and
baseline hazard (required for a CoxTime model) as input and internally
combines the base model with the CoxTime architecture. The
<code>model_type</code> argument is set to <code>"coxtime"</code> to
indicate that the model is a CoxTime model. The
<code>preprocess_fun</code> argument is set to the function we defined
earlier to add the time points to the input features.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create explainer object</span></span>
<span><span class="va">exp_coxtime</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">model_coxtime</span>, data <span class="op">=</span> <span class="va">data</span>, </span>
<span>                                 model_type <span class="op">=</span> <span class="st">"coxtime"</span>,</span>
<span>                                 baseline_hazard <span class="op">=</span> <span class="va">base_hazard</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">exp_coxtime</span><span class="op">)</span></span>
<span><span class="co">#&gt; Explainer for CoxTime model</span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; Model Class: CoxTime</span></span>
<span><span class="co">#&gt; Number of instances in the input data:  50 </span></span>
<span><span class="co">#&gt; Number of timepoints in the model:  50 </span></span>
<span><span class="co">#&gt; Model parameters:</span></span>
<span><span class="co">#&gt;  - Number of input modalities:  1 </span></span>
<span><span class="co">#&gt;  - Number of features:  10 </span></span>
<span><span class="co">#&gt;  - Baseline hazard function: Yes</span></span>
<span><span class="co">#&gt;  - Preprocessing function applied: Yes</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Features (first 5 shown):</span></span>
<span><span class="co">#&gt; X1, X2, X3, X4, X5 </span></span>
<span><span class="co">#&gt; -----------------------------------</span></span>
<span><span class="co">#&gt; To see more details, explore the individual elements of the object.</span></span>
<span></span>
<span><span class="co"># Calculate IntGrad(t)</span></span>
<span><span class="va">ig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_intgrad.html">surv_intgrad</a></span><span class="op">(</span><span class="va">exp_coxtime</span>, instance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show results as a contribution plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ig</span>, type <span class="op">=</span> <span class="st">"contr"</span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-8-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
</div>
<div class="section level2">
<h2 id="load-a-survivalmodels-model">Load a <code>survivalmodels</code> model<a class="anchor" aria-label="anchor" href="#load-a-survivalmodels-model"></a>
</h2>
<p>The <code>survivalmodels</code> package is a R package for survival
analysis using deep learning. Especially for the deep learning models,
it uses the <code>pycox</code> package in Python under the hood via
<code>reticulate</code>. The <code>survinng</code> package is designed
to load models trained in <code>survivalmodels</code> directly. However,
there are some issues when <code>torch</code> in R (i.e.,
<code>LibTorch</code>) and <code>Pytorch</code> in Python are loaded in
the same session (see <a href="https://github.com/mlverse/torch/issues/815" class="external-link">issue #815</a>).
Therefore, we keep the training procedure using
<code>survivalmodels</code> in a separate session using
<code>callr</code>.</p>
<p>In the following example, we will train a default DeepHit, DeepSurv
and Coxtime model using the <code>survivalmodels</code> package. The
models will be trained on the <code>lung</code> dataset from the
<code>survival</code> package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://callr.r-lib.org" class="external-link">callr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Load lung dataset</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">cancer</span>, package <span class="op">=</span> <span class="st">"survival"</span><span class="op">)</span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="va">cancer</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span>, <span class="fl">5</span>, <span class="fl">6</span>, <span class="fl">7</span>, <span class="fl">10</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Train models in separate session</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu">callr</span><span class="fu">::</span><span class="fu"><a href="https://callr.r-lib.org/reference/r.html" class="external-link">r</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/RaphaelS1/survivalmodels/" class="external-link">survivalmodels</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Set seed for reproducibility</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survivalmodels/man/set_seed.html" class="external-link">set_seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Make sure pycox is installed</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/survivalmodels/man/install_pycox.html" class="external-link">install_pycox</a></span><span class="op">(</span>install_torch <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fit the DeepSurv model</span></span>
<span>  <span class="va">fit_deepsurv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survivalmodels/man/deepsurv.html" class="external-link">deepsurv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                           num_nodes <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fit the DeepHit model</span></span>
<span>  <span class="va">fit_deephit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survivalmodels/man/deephit.html" class="external-link">deephit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                         cuts <span class="op">=</span> <span class="fl">30</span>, num_nodes <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Fit the CoxTime model</span></span>
<span>  <span class="va">fit_coxtime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survivalmodels/man/coxtime.html" class="external-link">coxtime</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">data</span>, epochs <span class="op">=</span> <span class="fl">10</span>,</span>
<span>                         num_nodes <span class="op">=</span> <span class="fl">8L</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Extract the models using `survinng`</span></span>
<span>  <span class="va">ext_deepsurv</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">fit_deepsurv</span><span class="op">)</span></span>
<span>  <span class="va">ext_deephit</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">fit_deephit</span><span class="op">)</span></span>
<span>  <span class="va">ext_coxtime</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/extract_model.html">extract_model</a></span><span class="op">(</span><span class="va">fit_coxtime</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># Return the extracted models</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>deepsurv <span class="op">=</span> <span class="va">ext_deepsurv</span>, deephit <span class="op">=</span> <span class="va">ext_deephit</span>, coxtime <span class="op">=</span> <span class="va">ext_coxtime</span><span class="op">)</span></span>
<span><span class="op">}</span>, args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Now, we have our trained models in the <code>models</code> list. The
models are extracted using the <code><a href="../reference/extract_model.html">extract_model()</a></code> function
from the <code>survinng</code> package. These objects and the data to be
explained can be passed to the <code><a href="../reference/explain.html">explain()</a></code> function to create
the <code>survinng</code> explainer objects.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create explainer objects</span></span>
<span><span class="va">exp_deepsurv</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">models</span><span class="op">$</span><span class="va">deepsurv</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">exp_deephit</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">models</span><span class="op">$</span><span class="va">deephit</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">exp_coxtime</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">models</span><span class="op">$</span><span class="va">coxtime</span>, data <span class="op">=</span> <span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/explain.html">explain()</a></code> function will automatically detect the
model type and create the corresponding explainer object, i.e., the
<code>model_type</code> argument is not needed in this case. Using the
explainer objects, we can compute the gradient-based feature attribution
methods. The <code>instance</code> argument is used to specify the
instances for which the explanations should be computed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Show instances to be explained</span></span>
<span><span class="va">ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">76</span><span class="op">)</span></span>
<span><span class="va">data</span><span class="op">[</span><span class="va">ids</span>, <span class="op">]</span></span>
<span><span class="co">#&gt;    inst age sex ph.ecog ph.karno wt.loss time status</span></span>
<span><span class="co">#&gt; 2     3  68   1       0       90      15  455      2</span></span>
<span><span class="co">#&gt; 83   11  42   1       1       80       8  196      1</span></span>
<span></span>
<span><span class="co"># Calculate feature attribution methods</span></span>
<span><span class="va">grad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_grad.html">surv_grad</a></span><span class="op">(</span><span class="va">exp_deepsurv</span>, instance <span class="op">=</span> <span class="va">ids</span><span class="op">)</span></span>
<span><span class="va">ig</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_intgrad.html">surv_intgrad</a></span><span class="op">(</span><span class="va">exp_deephit</span>, instance <span class="op">=</span> <span class="va">ids</span><span class="op">)</span></span>
<span><span class="va">shap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_gradSHAP.html">surv_gradSHAP</a></span><span class="op">(</span><span class="va">exp_coxtime</span>, instance <span class="op">=</span> <span class="va">ids</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show the predictions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">shap</span>, type <span class="op">=</span> <span class="st">"pred"</span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-11-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>With the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> function, we can visualize the results.
The <code>type</code> argument can be set to <code>"pred"</code> to show
the predictions of the model, <code>"attr"</code> to show the feature
attribution values, or <code>"contr"</code> to show the contribution
plots.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://wilkelab.org/cowplot/" class="external-link">cowplot</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">ig</span>, type <span class="op">=</span> <span class="st">"contr"</span>, aggregate <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"IntGrad(t) (aggregated)"</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">shap</span>, type <span class="op">=</span> <span class="st">"attr"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"SHAP"</span><span class="op">)</span>,</span>
<span>  ncol <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-12-1.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="load-a-pycox-python-model">Load a <code>pycox</code> Python model<a class="anchor" aria-label="anchor" href="#load-a-pycox-python-model"></a>
</h2>
<p>It is also possible to load models trained in Python using the
<code>pycox</code> package. Basically, it is the same procedure as for
another <a href="#load-a-base-torch-model"><code>torch::nn_module</code>
model</a>. The only difference is that the model needs to be loaded in R
as described in the <a href="https://torch.mlverse.org/docs/articles/python-to-r" class="external-link">Pyton to R
article</a> for the <code>torch</code> package. This means, the model
architecture must be rebuilt in R and the weights and parameters must be
loaded from the Python model.</p>
<p>For illustration, we will use the same CoxTime model from the
<code>pycox</code> Jupyter notebook <a href="https://github.com/havakv/pycox/blob/master/examples/cox-time.ipynb" class="external-link">here</a>
on the METABRIC dataset. After training the model, follow these steps to
extract the base hazard function and the model weights
(<code>model</code> and <code>x_test</code> are defined as in the
mentioned notebook):</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="co"># We use only a sample of the data for the baseline hazard</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>base_hazard <span class="op">=</span> model.compute_baseline_hazards(sample <span class="op">=</span> <span class="dv">200</span>)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co"># Save base hazard as csv</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>pd_base_hazard <span class="op">=</span> pd.DataFrame({</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="st">'time'</span>: base_hazard.index.to_numpy(), </span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="st">'hazard'</span>: base_hazard.to_numpy()})</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>pd_base_hazard.to_csv(<span class="st">'base_hazard.csv'</span>, index <span class="op">=</span> <span class="va">False</span>)</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="co"># Save model weights (not the  whole model!)</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>torch.save(model.net.net.state_dict(), <span class="st">'model.pt'</span>)</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co"># Save data to be explained</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>df_train.to_csv(<span class="st">'df_train.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>pd.DataFrame(x_val, columns <span class="op">=</span> df_val.columns[<span class="dv">0</span>:<span class="dv">9</span>]).to_csv(<span class="st">'x_val.csv'</span>, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<p>Now, the tricky part is rebuilding the model architecture in R with
the same names and parameters as in the Python model. This is done in
the following code:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Rebuild a dense layer</span></span>
<span><span class="va">BaseMLP_dense</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">in_feat</span>, <span class="va">out_feat</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">linear</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="va">in_feat</span>, <span class="va">out_feat</span><span class="op">)</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">batch_norm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_batch_norm1d.html" class="external-link">nn_batch_norm1d</a></span><span class="op">(</span><span class="va">out_feat</span><span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span></span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">linear</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_relu.html" class="external-link">nn_relu</a></span><span class="op">(</span><span class="op">)</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">self</span><span class="op">$</span><span class="fu">batch_norm</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rebuild the whole model</span></span>
<span><span class="va">BaseMLP</span> <span class="op">&lt;-</span> <span class="fu">torch</span><span class="fu">::</span><span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_module.html" class="external-link">nn_module</a></span><span class="op">(</span></span>
<span>  classname <span class="op">=</span> <span class="st">"BaseMLP"</span>,</span>
<span>  initialize <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">self</span><span class="op">$</span><span class="va">net</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_sequential.html" class="external-link">nn_sequential</a></span><span class="op">(</span></span>
<span>      <span class="fu">BaseMLP_dense</span><span class="op">(</span><span class="fl">10</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>      <span class="fu">BaseMLP_dense</span><span class="op">(</span><span class="fl">32</span>, <span class="fl">32</span><span class="op">)</span>,</span>
<span>      <span class="fu"><a href="https://torch.mlverse.org/docs/reference/nn_linear.html" class="external-link">nn_linear</a></span><span class="op">(</span><span class="fl">32</span>, <span class="fl">1</span>, bias <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span>,</span>
<span>  forward <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">is.list</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="va">x</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">self</span><span class="op">$</span><span class="fu">net</span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create model and load state dict</span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">BaseMLP</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">state_dict</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://torch.mlverse.org/docs/reference/load_state_dict.html" class="external-link">load_state_dict</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/articles/how_to_load_model/model.pt"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">load_state_dict</span><span class="op">(</span><span class="va">state_dict</span><span class="op">)</span></span>
<span><span class="va">model</span><span class="op">$</span><span class="fu">eval</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">model</span><span class="op">)</span></span>
<span><span class="co">#&gt; An `nn_module` containing 1,568 parameters.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; â”€â”€ Modules â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</span></span>
<span><span class="co">#&gt; â€¢ net: &lt;nn_sequential&gt; #1,568 parameters</span></span></code></pre></div>
<p>The model architecture is now rebuilt in R and the weights are loaded
from the Python model. The next step is to load the baseline hazard
function and the data to be explained. Additionally, since in the
notebook uses a label transformation, we need to rebuild the
transformation function in R. However, this is a simple mean and
standard deviation transformation, so we can use the
<code>labtrans</code> argument in the <code><a href="../reference/explain.html">explain()</a></code> function to
define the transformation function. The <code>labtrans</code> argument
is a list with two functions: <code>transform</code> and
<code>transform_inv</code>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load base hazard and data</span></span>
<span><span class="va">base_hazard</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/articles/how_to_load_model/base_hazard.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">df_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/articles/how_to_load_model/df_train.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.csv</a></span><span class="op">(</span><span class="fu"><a href="https://here.r-lib.org/reference/here.html" class="external-link">here</a></span><span class="op">(</span><span class="st">"vignettes/articles/how_to_load_model/x_val.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rebuild the label transformation</span></span>
<span><span class="va">mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df_train</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span></span>
<span><span class="va">sd</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">df_train</span><span class="op">$</span><span class="va">duration</span><span class="op">)</span></span>
<span><span class="va">labtrans</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  transform <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span> <span class="op">-</span> <span class="va">mean</span><span class="op">)</span> <span class="op">/</span> <span class="va">sd</span>,</span>
<span>  transform_inv <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span> <span class="op">*</span> <span class="va">sd</span> <span class="op">+</span> <span class="va">mean</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Now, we can create the <code>survinng</code> explainer object using
the <code><a href="../reference/explain.html">explain()</a></code> function and apply all implemented
gradient-based feature attribution methods on this model. The
<code>model_type</code> argument is set to <code>"coxtime"</code> to
indicate that the model is a CoxTime model and the <code>labtrans</code>
argument is set to the defined transformation.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create explainer</span></span>
<span><span class="va">explainer</span> <span class="op">&lt;-</span> <span class="fu">survinng</span><span class="fu">::</span><span class="fu"><a href="../reference/explain.html">explain</a></span><span class="op">(</span><span class="va">model</span>, data <span class="op">=</span> <span class="va">x_val</span>, model_type <span class="op">=</span> <span class="st">"coxtime"</span>,</span>
<span>                               baseline_hazard <span class="op">=</span> <span class="va">base_hazard</span>,</span>
<span>                               labtrans <span class="op">=</span> <span class="va">labtrans</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate GradSHAP(t)</span></span>
<span><span class="va">grad_shap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/surv_gradSHAP.html">surv_gradSHAP</a></span><span class="op">(</span><span class="va">explainer</span>, instance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show predictions</span></span>
<span><span class="va">p1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">grad_shap</span>, type <span class="op">=</span> <span class="st">"pred"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show attribution results</span></span>
<span><span class="va">p2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">grad_shap</span>, type <span class="op">=</span> <span class="st">"attr"</span>, add_comp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"pred_diff"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Show contribution percentages</span></span>
<span><span class="va">p3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">grad_shap</span>, type <span class="op">=</span> <span class="st">"contr"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">cowplot</span><span class="fu">::</span><span class="fu"><a href="https://wilkelab.org/cowplot/reference/plot_grid.html" class="external-link">plot_grid</a></span><span class="op">(</span><span class="va">p1</span>, <span class="va">p2</span>, <span class="va">p3</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="how_to_load_model_files/figure-html/unnamed-chunk-16-1.png" width="100%" style="display: block; margin: auto;"></p>
<p>In a similar way, you can also load DeepSurv and DeepHit models from
<code>pycox</code>. The only difference is that the model architecture
must be changed accordingly. The <code>model_type</code> argument is set
to <code>"deepsurv"</code> or <code>"deephit"</code> to indicate the
model type.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Niklas Koenen, Sophie Hanna Langbein.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
